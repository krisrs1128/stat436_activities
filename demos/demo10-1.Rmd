---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---

```{r, echo = FALSE}
knitr::opts_chunk$set(warnings = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(glue)
library(tidymodels)
th <- theme_minimal() +
    theme(
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "#f7f7f7"),
        panel.border = element_rect(fill = NA, color = "#0c0c0c"),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 16),
        strip.text = element_text(size = 16),
        legend.position = "bottom"
    )
theme_set(th)
```

[Olympics PCA - Continued] Let's study Olympics dataset from the previous
problem. We'll apply PCA ourselves, compare alternative visual encodings, and
clarify the impact of standardization. The code below loads the package.

```{r}
data(olympic, package = "ade4")
head(olympic$tab)
```

a. Define a tidymodels recipe that normalizes all features and specifies that
PCA should be performed.

```{r}
rec <- recipe(~ ., olympic$tab) |>
    step_normalize(all_predictors()) |>
    step_pca(all_predictors())
fit <- prep(rec, olympic$tab)
```

b. Plot and interpret the variance explained by each principal component.

```{r}
prop_var <- tidy(fit, 2, type = "variance") |>
    filter(terms == "percent variance") |>
    mutate(
        component = glue("PC{component}"),
        component = factor(component, levels = component)
    ) |>
    rename(prop = value)

ggplot(prop_var) +
    geom_col(aes(component, prop)) +
    labs(
        x = "Principal Component",
        y = "Proportion Variance Explained (%)"
    )
```

c. Visualize the scores associated with each athlete.

```{r}
scores <- bake(fit, olympic$tab) |>
    mutate(id = row_number())

ggplot(scores, aes(PC1, PC2)) +
    geom_hline(yintercept = 0, linewidth = 1, col = "#c6c6c6") +
    geom_vline(xintercept = 0, linewidth = 1, col = "#c6c6c6") +
    geom_point() +
    geom_label(aes(label = id), nudge_y = .3) +
    labs(
        x = glue("PC1 [{round(prop_var$prop[1], 2)}%]"),
        y = glue("PC2 [{round(prop_var$prop[2], 2)}%]")
    ) +
    coord_fixed()
```

d. Visualize the top 4 principal components.  Pick an athlete from part (c) and
comment on their performance relative to the average decathlete for that year.

```{r}
tidy(fit, 2) |>
    filter(component %in% glue("PC{1:4}")) |>
    left_join(select(prop_var, component, prop)) |>
    mutate(label = glue("{component} [{round(prop, 1)}%]")) |>
    ggplot() +
        geom_col(aes(value, terms)) +
        facet_wrap(~ label)
```

e. Rerun the previous steps but with normalization replaced with only scaling
(not centering). How do the results change? Which approach would you recommend
and why?